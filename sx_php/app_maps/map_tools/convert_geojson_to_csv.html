<!DOCTYPE html>
<html lang="en">

<head>
    <title>Convert GeoJSON Points to CSV | Digital Periegesis</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="language" content="en" />
    <meta name="creator" content="Public Sphere" />
    <meta name="title" content="Convert GeoJSON Points to CSV | Digital Periegesis" />
    <meta name="description"
        content="Convert GeoJSON files with Point geometries to CSV format. Includes coordinate fields and optional PlaceID indexing." />
    <meta name="keywords"
        content="GeoJSON to CSV, convert GeoJSON, Point geometry, PlaceID, latitude longitude, Digital Periegesis" />

    <meta property="og:type" content="website" />
    <meta property="og:title" content="Convert GeoJSON Points to CSV | Digital Periegesis" />
    <meta property="og:description"
        content="Convert GeoJSON files with Point geometries to CSV format. Includes coordinate fields and optional PlaceID indexing." />
    <meta property="og:site_name" content="Digital Periegesis" />
    <meta property="og:url" content="https://www.periegesis.org/en/map_tools.php?p=convert-geojson-to-csv" />

    <link rel="icon" type="image/svg+xml" href="../images/logo/favicon.svg">
    <link rel="canonical" href="https://www.periegesis.org/en/map_tools.php?p=convert-geojson-to-csv" />

    <style>
        html {
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 18px;
            padding: 0;
            margin: 0;
            margin-bottom: 4rem;
        }

        .header {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.5rem 20%;
            background-color: #003D7A;
            color: #ffffffcc;
        }

        h2 {
            text-align: center;
        }

        .fixed {
            position: fixed;
            top: 0.5rem;
            left: 0.5rem;
        }

        .fixed a {
            color: #ffffffcc;
            text-decoration: none;
        }

        .fixed a:hover {
            color: #ffffff;
        }

        .flex {
            display: flex;
            justify-content: space-around;
            margin: 1rem auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        input,
        button {
            padding: 0.5rem;
        }

        .container {
            width: 100%;
            max-width: 1024px;
            padding: 1rem;
            margin: 0 auto;
            background-color: #f6f6f6;
            border: 1px solid #ddd;
            line-height: 1.5;
        }

        input[type="checkbox"] {
            height: 1rem;
            width: 1rem;
            vertical-align: middle;
            accent-color: #b1c999;
        }

        #loadingContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }

        #loadingContainer img {
            display: none;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="fixed">
            <a title="Home to Digital Periegesis" href="index.php">dp</a><br>
            <a title="Search in Maps" href="map_search.php">SM</a>
        </div>
        <label for="kmlFile">Choose GeoJson file:
            <input type="file" id="GeojsonInput" accept=".geojson">
        </label>
        <div class="grid">
            <label><input type="checkbox" id="DefaultLatLon" checked> Lat/Lon <small>(default)</small></label>
            <label><input type="checkbox" id="AddPlaceID"> Add PlaceID</label>
            <label><input type="text" id="CustomLat" value="" placeholder="Custom Latitude"></label>
            <label><input type="text" id="CustomLon" value="" placeholder="Custom Longitude"></label>
        </div>
        <button onclick="convert_GeoJSONToCSV()">Convert to CSV</button>
    </div>
    <h2>Convert GeoJson Files with <u>Point Geometries</u> to CSV Files</h2>
    <div class="flex">
        <div class="container">
            <p>You can use this converter only with GeoJson files containing the geometry type <b>Points</b>.</p>
            <ul>
                <li><b>Property Names</b> from the GeoJson file are converted to <b>Field Names</b>.</li>
                <li>Two fields for <b>map coordinates</b> are added with the default names <b>Lat</b> for latitude and
                    <b>Lon</b> for longitude, which you can change.
                </li>
                <li>Optionally, you can add a field with the named <b>PlaceID</b> as first field, like a Primary Key,
                    with auto-augmented integer values, starting from 1.</li>
            </ul>
        </div>
    </div>

    <p id="loadingContainer">
        <img id="loadingImg" src="../imgPG/loading_blue.gif"> <span id="loadingText"></span>
    </p>

    <div id="downloadLinks" class="flex"></div>
    <div class="flex">
        <div id="validationInfo"></div>
    </div>

    <script>
        function escapeArrayForCSV(arr) {
            if (!Array.isArray(arr)) return '[]';
            return `[${arr.map(v => `""${String(v).replace(/"/g, '""')}""`).join(',')}]`;
        }

        function escapeValueForCSV(val) {
            if (val === null || val === undefined) return '';
            return String(val).replace(/\n/g, ' ').replace(/"/g, '""');
        }

        function showSpinner(message = 'Converting...') {
            document.getElementById('loadingImg').style.display = 'block';
            document.getElementById('loadingText').textContent = message;
        }

        function hideSpinner() {
            document.getElementById('loadingImg').style.display = 'none';
            document.getElementById('loadingText').textContent = '';
        }


        function convert_GeoJSONToCSV() {
            document.getElementById('validationInfo').innerHTML = '';
            document.getElementById('downloadLinks').innerHTML = '';

            const add_PlaceID = document.getElementById('AddPlaceID').checked;
            const default_LatLon = document.getElementById('DefaultLatLon').checked;
            const custom_Lat = document.getElementById('CustomLat').value;
            const custom_Lon = document.getElementById('CustomLon').value;
            let cLat = 'Lat';
            let cLon = 'Lon';

            if (!default_LatLon) {
                if (custom_Lat) {
                    cLat = custom_Lat.trim();
                }
                if (custom_Lon) {
                    cLon = custom_Lon.trim();
                }
            }

            if (cLat === '' || cLon === '') {
                alert('Please, define the name of Latitude and Longitude!')
                return;
            }

            let version_updated = new Date().toISOString().split('T')[0];
            let fiel_Name = 'Geo_to_CSV';

            const input = document.getElementById('GeojsonInput');
            const file = input.files[0];
            if (!file) return alert("Please select a .geojson file first.");

            showSpinner();
            fiel_Name = file.name.replace(/\.[^/.]+$/, "");
            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const geojson = JSON.parse(event.target.result);
                    const features = geojson.features || [];
                    if (!features.length) {
                        hideSpinner();
                        return alert("No features found in the file.");
                    }
                    const invalidGeometries = features.filter(f =>
                        f.geometry?.type !== 'Point'
                    );

                    if (invalidGeometries.length > 0) {
                        hideSpinner();
                        alert(`Only Point geometries are supported. Found ${invalidGeometries.length} feature(s) with unsupported types like "${invalidGeometries[0].geometry?.type}".`);
                        return;
                    }

                    const headers = new Set();
                    if (add_PlaceID) {
                        headers.add('PlaceID');
                    }
                    headers.add(cLat);
                    headers.add(cLon);

                    // console.log('headers: ', headers);

                    let count_Invalid = 0;
                    let count_Total = 0;
                    const invalid_rows = [];

                    const rows = [];
                    features.forEach((feature, index) => {
                        const row = {};
                        if (add_PlaceID) {
                            row.PlaceID = index + 1;
                        }
                        const coords = feature.geometry?.coordinates || [null, null];
                        row[cLon] = coords[0];
                        row[cLat] = coords[1];

                        if (coords[0] === undefined || coords[0] === null) {
                            count_Invalid++;
                            invalid_rows.push(`Row: ${index + 1}`);
                        }

                        // console.log('headers: ', headers);

                        const props = feature.properties || {};
                        Object.entries(props).forEach(([key, value]) => {
                            headers.add(key);
                            if (Array.isArray(value)) {
                                row[key] = escapeArrayForCSV(value);
                            } else {
                                row[key] = escapeValueForCSV(value);
                            }
                        });

                        rows.push(row);
                        // console.log('rows: ', rows);

                        count_Total = index + 1;
                    });


                    const headerList = Array.from(headers);
                    const csv = [headerList.join(',')].concat(
                        rows.map(row =>
                            headerList.map(h => `"${row[h] || ''}"`).join(',')
                        )
                    ).join('\n');

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${fiel_Name}_${version_updated}.csv`;
                    link.textContent = 'Download CSV';
                    link.style.display = 'block';
                    document.getElementById('downloadLinks').innerHTML = '';
                    document.getElementById('downloadLinks').appendChild(link);
                    hideSpinner();

                    let html = `<p>${count_Total} GeoJson Features have been converted to CSV rows.</p>`;
                    if (count_Invalid > 0) {
                        html += `<p>${count_Invalid} feature(s) have <b>invalid coordinates</b> at the CSV row(s): <br>${invalid_rows.join('<br>')}</p>`;
                    }

                    document.getElementById('validationInfo').innerHTML = html;
                    console.log('rows: ', invalid_rows)
                    console.log('count_Invalid: ', count_Invalid)
                    console.log('count_Total: ', count_Total)

                } catch (e) {
                    hideSpinner();
                    alert("Error parsing .geojson file. Please ensure it is valid.");
                }
            };

            reader.readAsText(file);
        }
    </script>
</body>

</html>